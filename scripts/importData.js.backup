// Data import script to convert CSV data to Firestore
import admin from 'firebase-admin';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import csv from 'csv-parser';
import dotenv from 'dotenv';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

dotenv.config({ path: path.join(__dirname, '..', 'client', '.env') });

// Initialize Firebase Admin
// TODO: Replace with your service account key
const serviceAccount = {
  // You'll need to download your Firebase service account key and place it here
  // or load it from a file
  projectId: process.env.VITE_FIREBASE_PROJECT_ID || 'project-estimator-1584',
};

let db = null;

try {
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
  });
  db = admin.firestore();
  console.log('Firebase Admin initialized successfully');
} catch (error) {
  console.log('Note: Firebase Admin initialization skipped. Add service account credentials to use.');
  console.log('For now, this script will generate the data structure for manual import.');
  console.log('Error:', error.message);
}

// Helper function to parse currency string to cents
function parseCurrency(value) {
  if (!value || value === '' || value === '-') return 0;
  const cleaned = value.toString().replace(/[$,]/g, '');
  const dollars = parseFloat(cleaned);
  return Math.round(dollars * 100);
}

// Helper function to create slug from name
function slugify(text) {
  return text
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '_')
    .replace(/^_+|_+$/g, '');
}

// Import items from Item Pricing CSV
async function importItems() {
  const items = [];
  const csvPath = path.join(__dirname, '..', 'initial_dataset', '1584 - Standard Room Items_Pricing Ranges - Item Pricing.csv');

  return new Promise((resolve, reject) => {
    if (!fs.existsSync(csvPath)) {
      console.log('CSV file not found:', csvPath);
      reject(new Error('CSV file not found'));
      return;
    }

    fs.createReadStream(csvPath)
      .pipe(csv())
      .on('data', (row) => {
        const item = {
          id: slugify(row.Item || row.item),
          name: row.Item || row.item,
          category: inferCategory(row.Item || row.item),
          budgetPrice: parseCurrency(row['Budget Price'] || row['budget']),
          midPrice: parseCurrency(row['Mid Price'] || row['mid']),
          midHighPrice: parseCurrency(row['Mid/High Price'] || row['midhigh']),
          highPrice: parseCurrency(row['High Price'] || row['high']),
          unit: 'each',
          notes: '',
          createdAt: db ? admin.firestore.FieldValue.serverTimestamp() : new Date(),
          updatedAt: db ? admin.firestore.FieldValue.serverTimestamp() : new Date(),
        };

        if (item.name && item.budgetPrice > 0) {
          items.push(item);
        }
      })
      .on('end', () => {
        console.log(`Parsed ${items.length} items from CSV`);
        resolve(items);
      })
      .on('error', reject);
  });
}

// Infer category from item name
function inferCategory(itemName) {
  const name = itemName.toLowerCase();
  
  const categoryMap = {
    'bed': 'bedroom_furniture',
    'mattress': 'bedroom_furniture',
    'nightstand': 'bedroom_furniture',
    'dresser': 'bedroom_furniture',
    'sofa': 'living_room_furniture',
    'sectional': 'living_room_furniture',
    'chair': 'living_room_furniture',
    'coffee table': 'living_room_furniture',
    'side table': 'living_room_furniture',
    'dining table': 'dining_furniture',
    'dining chair': 'dining_furniture',
    'bar stool': 'kitchen_furniture',
    'curtain': 'textiles',
    'rug': 'textiles',
    'pillow': 'textiles',
    'sheet': 'textiles',
    'blanket': 'textiles',
    'bedding': 'textiles',
    'lamp': 'lighting',
    'chandelier': 'lighting',
    'mirror': 'decorative',
    'art': 'decorative',
    'wall art': 'decorative',
    'plant': 'decorative',
    'greenery': 'decorative',
    'tv': 'electronics',
    'television': 'electronics',
  };

  for (const [keyword, category] of Object.entries(categoryMap)) {
    if (name.includes(keyword)) {
      return category;
    }
  }

  return 'accessories';
}

// Import room data from all CSV files
async function importRoomData() {
  const roomData = {};

  // Map CSV filenames to room IDs
  const roomFiles = {
    '1584 - Standard Room Items_Pricing Ranges - Living Room.csv': 'living_room',
    '1584 - Standard Room Items_Pricing Ranges - Kitchen.csv': 'kitchen',
    '1584 - Standard Room Items_Pricing Ranges - Dining Room.csv': 'dining_room',
    '1584 - Standard Room Items_Pricing Ranges - Single Bedroom.csv': 'single_bedroom',
    '1584 - Standard Room Items_Pricing Ranges - Double Bedroom.csv': 'double_bedroom',
    '1584 - Standard Room Items_Pricing Ranges - Bunk Room.csv': 'bunk_room',
    '1584 - Standard Room Items_Pricing Ranges - Rec Room.csv': 'rec_room'
  };

  // Room configuration
  const roomTypes = [
    { id: 'living_room', name: 'Living Room', category: 'common_spaces', icon: 'ðŸ›‹ï¸' },
    { id: 'kitchen', name: 'Kitchen', category: 'common_spaces', icon: 'ðŸ³' },
    { id: 'dining_room', name: 'Dining Room', category: 'common_spaces', icon: 'ðŸ½ï¸' },
    { id: 'single_bedroom', name: 'Single Bedroom', category: 'sleeping_spaces', icon: 'ðŸ›ï¸' },
    { id: 'double_bedroom', name: 'Double Bedroom', category: 'sleeping_spaces', icon: 'ðŸ›ï¸' },
    { id: 'bunk_room', name: 'Bunk Room', category: 'sleeping_spaces', icon: 'ðŸ›ï¸' },
    { id: 'rec_room', name: 'Rec Room', category: 'common_spaces', icon: 'ðŸŽ®' }
  ];

  for (const roomType of roomTypes) {
    const csvFileName = Object.keys(roomFiles).find(file => roomFiles[file] === roomType.id);
    if (!csvFileName) continue;

    const csvPath = path.join(__dirname, '..', 'initial_dataset', csvFileName);

    try {
      const roomTotals = await parseRoomTotalsFromCSV(csvPath);

      // Create basic room items (placeholder - would be populated from CSV in production)
      const basicItems = [
        { itemId: 'basic_furniture', quantity: 1 },
        { itemId: 'decorative_items', quantity: 2 },
        { itemId: 'lighting', quantity: 1 }
      ];

      roomData[roomType.id] = {
        id: roomType.id,
        name: roomType.name,
        displayName: roomType.name,
        description: `Complete ${roomType.name.toLowerCase()} setup with furnishings`,
        category: roomType.category,
        icon: roomType.icon,
        active: true,
        sortOrder: roomTypes.findIndex(r => r.id === roomType.id) + 1,
        sizes: {
          small: {
            displayName: `Small ${roomType.name}`,
            items: basicItems,
            totals: {
              budget: Math.round(roomTotals.small.budget * 100),    // Convert to cents
              mid: Math.round(roomTotals.small.mid * 100),
              midHigh: Math.round(roomTotals.small.midHigh * 100),
              high: Math.round(roomTotals.small.high * 100)
            }
          },
          medium: {
            displayName: `Medium ${roomType.name}`,
            items: basicItems.map(item => ({ ...item, quantity: Math.ceil(item.quantity * 1.5) })),
            totals: {
              budget: Math.round(roomTotals.medium.budget * 100),
              mid: Math.round(roomTotals.medium.mid * 100),
              midHigh: Math.round(roomTotals.medium.midHigh * 100),
              high: Math.round(roomTotals.medium.high * 100)
            }
          },
          large: {
            displayName: `Large ${roomType.name}`,
            items: basicItems.map(item => ({ ...item, quantity: item.quantity * 2 })),
            totals: {
              budget: Math.round(roomTotals.large.budget * 100),
              mid: Math.round(roomTotals.large.mid * 100),
              midHigh: Math.round(roomTotals.large.midHigh * 100),
              high: Math.round(roomTotals.large.high * 100)
            }
          }
        },
        createdAt: db ? admin.firestore.FieldValue.serverTimestamp() : new Date(),
        updatedAt: db ? admin.firestore.FieldValue.serverTimestamp() : new Date()
      };

    } catch (error) {
      console.error(`Error parsing ${csvFileName}:`, error.message);
      // Use default values if CSV parsing fails
      createDefaultRoomData(roomData, roomType);
    }
  }

  return roomData;
}

// Parse room totals from CSV file
function parseRoomTotalsFromCSV(csvPath) {
  return new Promise((resolve, reject) => {
    const totals = { small: {}, medium: {}, large: {} };

    if (!fs.existsSync(csvPath)) {
      reject(new Error(`CSV file not found: ${csvPath}`));
      return;
    }

    let foundTotalsSection = false;

    fs.createReadStream(csvPath)
      .pipe(csv())
      .on('data', (row) => {
        const rowText = Object.values(row).join(',').toLowerCase();

        // Look for the totals section
        if (rowText.includes('small room totals')) {
          foundTotalsSection = true;
          totals.small = {
            budget: parseCurrency(row['Budget Pricing'] || row['budget pricing'] || 0),
            mid: parseCurrency(row['Mid Pricing'] || row['mid pricing'] || 0),
            midHigh: parseCurrency(row['Mid/High Pricing'] || row['mid/high pricing'] || 0),
            high: parseCurrency(row['High Pricing'] || row['high pricing'] || 0)
          };
        } else if (rowText.includes('medium room totals') && foundTotalsSection) {
          totals.medium = {
            budget: parseCurrency(row['Budget Pricing'] || row['budget pricing'] || 0),
            mid: parseCurrency(row['Mid Pricing'] || row['mid pricing'] || 0),
            midHigh: parseCurrency(row['Mid/High Pricing'] || row['mid/high pricing'] || 0),
            high: parseCurrency(row['High Pricing'] || row['high pricing'] || 0)
          };
        } else if (rowText.includes('large room totals') && foundTotalsSection) {
          totals.large = {
            budget: parseCurrency(row['Budget Pricing'] || row['budget pricing'] || 0),
            mid: parseCurrency(row['Mid Pricing'] || row['mid pricing'] || 0),
            midHigh: parseCurrency(row['Mid/High Pricing'] || row['mid/high pricing'] || 0),
            high: parseCurrency(row['High Pricing'] || row['high pricing'] || 0)
          };
        }
      })
      .on('end', () => {
        resolve(totals);
      })
      .on('error', reject);
  });
}

// Fallback function to create default room data if CSV parsing fails
function createDefaultRoomData(roomData, roomType) {
  const basicItems = [
    { itemId: 'basic_furniture', quantity: 1 },
    { itemId: 'decorative_items', quantity: 2 },
    { itemId: 'lighting', quantity: 1 }
  ];

  roomData[roomType.id] = {
    id: roomType.id,
    name: roomType.name,
    displayName: roomType.name,
    description: `Complete ${roomType.name.toLowerCase()} setup with furnishings`,
    category: roomType.category,
    icon: roomType.icon,
    active: true,
    sortOrder: roomTypes.findIndex(r => r.id === roomType.id) + 1,
    sizes: {
      small: {
        displayName: `Small ${roomType.name}`,
        items: basicItems,
        totals: {
          budget: 800000,    // $8,000 - fallback
          mid: 1500000,      // $15,000
          midHigh: 2500000,  // $25,000
          high: 4000000      // $40,000
        }
      },
      medium: {
        displayName: `Medium ${roomType.name}`,
        items: basicItems.map(item => ({ ...item, quantity: Math.ceil(item.quantity * 1.5) })),
        totals: {
          budget: 1200000,   // $12,000
          mid: 2250000,      // $22,500
          midHigh: 3750000,  // $37,500
          high: 6000000      // $60,000
        }
      },
      large: {
        displayName: `Large ${roomType.name}`,
        items: basicItems.map(item => ({ ...item, quantity: item.quantity * 2 })),
        totals: {
          budget: 1600000,   // $16,000
          mid: 3000000,      // $30,000
          midHigh: 5000000,  // $50,000
          high: 8000000      // $80,000
        }
      }
    },
    createdAt: db ? admin.firestore.FieldValue.serverTimestamp() : new Date(),
    updatedAt: db ? admin.firestore.FieldValue.serverTimestamp() : new Date()
  };
}

// Calculate room totals based on items
function calculateRoomTotal(items, size) {
  let multiplier = 1;
  if (size === 'medium') multiplier = 1.5;
  if (size === 'large') multiplier = 2;

  // For now, use placeholder totals - in a real implementation,
  // you'd look up actual prices from the items collection
  const baseTotal = 1000000; // $10,000 base
  return {
    budget: Math.round(baseTotal * multiplier),
    mid: Math.round(baseTotal * 2 * multiplier),
    midHigh: Math.round(baseTotal * 3.5 * multiplier),
    high: Math.round(baseTotal * 7 * multiplier)
  };
}

// Helper functions for room metadata
function formatRoomName(roomName) {
  return roomName.split(' ').map(word =>
    word.charAt(0).toUpperCase() + word.slice(1)
  ).join(' ');
}

function formatRoomDisplayName(roomName) {
  return formatRoomName(roomName);
}

function getRoomDescription(roomId) {
  const descriptions = {
    'living_room': 'Common living space with seating',
    'kitchen': 'Kitchen space with appliances and furnishings',
    'dining_room': 'Dining space with table and seating',
    'single_bedroom': 'Guest bedroom with one bed',
    'double_bedroom': 'Bedroom with two beds',
    'bunk_room': 'Room with bunk beds',
    'rec_room': 'Recreation/entertainment room'
  };
  return descriptions[roomId] || 'Room description';
}

function getRoomCategory(roomId) {
  const categories = {
    'living_room': 'common_spaces',
    'kitchen': 'common_spaces',
    'dining_room': 'common_spaces',
    'rec_room': 'common_spaces',
    'single_bedroom': 'sleeping_spaces',
    'double_bedroom': 'sleeping_spaces',
    'bunk_room': 'sleeping_spaces'
  };
  return categories[roomId] || 'common_spaces';
}

function getRoomIcon(roomId) {
  const icons = {
    'living_room': 'ðŸ›‹ï¸',
    'kitchen': 'ðŸ³',
    'dining_room': 'ðŸ½ï¸',
    'single_bedroom': 'ðŸ›ï¸',
    'double_bedroom': 'ðŸ›ï¸',
    'bunk_room': 'ðŸ›ï¸',
    'rec_room': 'ðŸŽ®'
  };
  return icons[roomId] || 'ðŸ ';
}

function getRoomSortOrder(roomId) {
  const orders = {
    'living_room': 1,
    'kitchen': 2,
    'dining_room': 3,
    'single_bedroom': 4,
    'double_bedroom': 5,
    'bunk_room': 6,
    'rec_room': 7
  };
  return orders[roomId] || 99;
}

// Create room templates (legacy function for backward compatibility)
function createRoomTemplates() {
  const templates = [
    {
      id: 'living_room',
      name: 'Living Room',
      displayName: 'Living Room',
      description: 'Common living space with seating',
      category: 'common_spaces',
      icon: 'ðŸ›‹ï¸',
      active: true,
      sortOrder: 1,
    },
    {
      id: 'kitchen',
      name: 'Kitchen',
      displayName: 'Kitchen',
      description: 'Kitchen space with appliances and furnishings',
      category: 'common_spaces',
      icon: 'ðŸ³',
      active: true,
      sortOrder: 2,
    },
    {
      id: 'dining_room',
      name: 'Dining Room',
      displayName: 'Dining Room',
      description: 'Dining space with table and seating',
      category: 'common_spaces',
      icon: 'ðŸ½ï¸',
      active: true,
      sortOrder: 3,
    },
    {
      id: 'single_bedroom',
      name: 'Single Bedroom',
      displayName: 'Single Bedroom',
      description: 'Guest bedroom with one bed',
      category: 'sleeping_spaces',
      icon: 'ðŸ›ï¸',
      active: true,
      sortOrder: 4,
    },
    {
      id: 'double_bedroom',
      name: 'Double Bedroom',
      displayName: 'Double Bedroom',
      description: 'Bedroom with two beds',
      category: 'sleeping_spaces',
      icon: 'ðŸ›ï¸',
      active: true,
      sortOrder: 5,
    },
    {
      id: 'bunk_room',
      name: 'Bunk Room',
      displayName: 'Bunk Room',
      description: 'Room with bunk beds',
      category: 'sleeping_spaces',
      icon: 'ðŸ›ï¸',
      active: true,
      sortOrder: 6,
    },
    {
      id: 'rec_room',
      name: 'Rec Room',
      displayName: 'Rec Room',
      description: 'Recreation/entertainment room',
      category: 'common_spaces',
      icon: 'ðŸŽ®',
      active: true,
      sortOrder: 7,
    },
  ];

  return templates;
}

// Main import function
async function runImport() {
  console.log('Starting data import...\n');

  try {
    // Import items
    console.log('1. Importing items from CSV...');
    const items = await importItems();
    console.log(`Found ${items.length} items to import\n`);

    // Create room templates with pricing data
    console.log('2. Creating room templates with pricing data...');
    const roomData = await importRoomData();
    const templates = Object.values(roomData);
    console.log(`Created ${templates.length} room templates with pricing data\n`);

    // Export as JSON for manual review/import
    const outputDir = path.join(__dirname, 'output');
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir);
    }

    fs.writeFileSync(
      path.join(outputDir, 'items.json'),
      JSON.stringify(items, null, 2)
    );
    console.log('âœ“ Items exported to scripts/output/items.json');

    fs.writeFileSync(
      path.join(outputDir, 'roomTemplates.json'),
      JSON.stringify(templates, null, 2)
    );
    console.log('âœ“ Room templates exported to scripts/output/roomTemplates.json');

    fs.writeFileSync(
      path.join(outputDir, 'roomData.json'),
      JSON.stringify(roomData, null, 2)
    );
    console.log('âœ“ Room data exported to scripts/output/roomData.json');

    // Import to Firestore if Firebase Admin is available
    if (db) {
      console.log('\n3. Importing data to Firestore...');
      try {
        // Import items
        const batch = db.batch();
        items.forEach(item => {
          const docRef = db.collection('items').doc(item.id);
          batch.set(docRef, item);
        });

        await batch.commit();
        console.log(`âœ“ Imported ${items.length} items to Firestore`);

        // Import room templates
        const templateBatch = db.batch();
        templates.forEach(template => {
          const docRef = db.collection('roomTemplates').doc(template.id);
          templateBatch.set(docRef, template);
        });

        await templateBatch.commit();
        console.log(`âœ“ Imported ${templates.length} room templates to Firestore`);

        // Also import as roomData collection for easier lookup
        const roomDataBatch = db.batch();
        Object.entries(roomData).forEach(([roomId, room]) => {
          const docRef = db.collection('roomData').doc(roomId);
          roomDataBatch.set(docRef, room);
        });

        await roomDataBatch.commit();
        console.log(`âœ“ Imported ${Object.keys(roomData).length} room data entries to Firestore`);

        console.log('\nâœ… Data import complete!');
      } catch (error) {
        console.error('Error importing to Firestore:', error);
        console.log('Please import the JSON files manually using Firebase Console');
      }
    } else {
      console.log('\nâœ… Data export complete!');
      console.log('\nNext steps:');
      console.log('1. Review the generated JSON files in scripts/output/');
      console.log('2. Set up Firebase project and add service account credentials');
      console.log('3. Import the data to Firestore using Firebase Console or this script');
    }

    process.exit(0);
  } catch (error) {
    console.error('Error during import:', error);
    process.exit(1);
  }
}

// Run the import
runImport();

